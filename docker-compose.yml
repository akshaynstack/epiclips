services:
  genesis:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: viewcreator-genesis
    ports:
      - "8000:8000"
    env_file:
      - .env  # Load from .env file
    environment:
      # AWS Configuration (use your credentials)
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - S3_BUCKET=${S3_BUCKET:-viewcreator-media}
      
      # Model Configuration
      - YOLO_MODEL_PATH=/app/models/yolov8n.pt
      
      # Processing Settings
      - FRAME_INTERVAL_SECONDS=2.0
      - MAX_CONCURRENT_JOBS=2
      - TEMP_DIRECTORY=/tmp/genesis
      
      # Detection Thresholds
      - FACE_CONFIDENCE_THRESHOLD=0.5
      - POSE_CONFIDENCE_THRESHOLD=0.5
      - TRACKING_MAX_AGE=30
      
      # AI Services Configuration
      # Transcription (Groq Whisper)
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      
      # Intelligence Planning (Gemini via OpenRouter)
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - INTELLIGENCE_MODEL=${INTELLIGENCE_MODEL:-google/gemini-2.0-flash-001}

      # Security - API Authentication (must match viewcreator-api configuration)
      - GENESIS_API_KEY=${GENESIS_API_KEY:-}
      - GENESIS_WEBHOOK_SECRET=${GENESIS_WEBHOOK_SECRET:-}

      # Rendering Configuration
      - TARGET_OUTPUT_WIDTH=1080
      - TARGET_OUTPUT_HEIGHT=1920
      - FFMPEG_PRESET=medium
      - FFMPEG_CRF=23
      
      # Logging
      - LOG_LEVEL=INFO
      - DEBUG=false
    
    volumes:
      # Persistent temp storage (optional)
      - genesis-temp:/tmp/genesis
      # NOTE: For local development with hot-reload, uncomment the line below
      # after adding this path to Docker Desktop's File Sharing settings
      # - ./app:/app/app:ro
    
    # Resource limits (adjust based on your needs)
    # Note: AI clipping requires more resources than detection alone
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    restart: unless-stopped

  # Optional: LocalStack for S3 emulation in development
  localstack:
    image: localstack/localstack:latest
    container_name: viewcreator-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEBUG=0
      - DATA_DIR=/var/lib/localstack/data
    volumes:
      - localstack-data:/var/lib/localstack
    profiles:
      - localstack  # Only start with: docker-compose --profile localstack up

volumes:
  genesis-temp:
  localstack-data:

networks:
  default:
    name: viewcreator-network

